// Copyright © 2023 OpenIM. All rights reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

syntax = "proto3";
package openim.msg;

import "conversation/conversation.proto";
import "sdkws/sdkws.proto";

option go_package = "github.com/openimsdk/protocol/msg";

message MsgDataToMQ {
  string token = 1;
  sdkws.MsgData msgData = 2;
}

message MsgDataToDB {
  sdkws.MsgData msgData = 1;
}

message PushMsgDataToMQ {
  sdkws.MsgData msgData = 1;
  string conversationID = 2;
}

message MsgDataToMongoByMQ {
  int64 lastSeq = 1;
  string conversationID = 2;
  repeated sdkws.MsgData msgData = 3;
}

message GetMaxAndMinSeqReq {
  string UserID = 1;
}
message GetMaxAndMinSeqResp {
  int64 MaxSeq = 1;
  int64 MinSeq = 2;
}

message SendMsgReq {
  sdkws.MsgData msgData = 3;
}

message SendMsgResp {
  string serverMsgID = 1;
  string clientMsgID = 2;
  int64 sendTime = 3;
  sdkws.MsgData modify = 4;
}

message SendSimpleMsgReq {
  sdkws.MsgData msgData = 3;
}

message SendSimpleMsgResp {
  string serverMsgID = 1;
  string clientMsgID = 2;
  int64 sendTime = 3;
  sdkws.MsgData modify = 4;
}


message SetSendMsgStatusReq {
  int32 status = 1;
}

message SetSendMsgStatusResp {}

message GetSendMsgStatusReq {}

message GetSendMsgStatusResp {
  int32 status = 1;
}

message MsgDataToModifyByMQ {
  repeated sdkws.MsgData messages = 1;
  string conversationID = 2;
}

message DelMsgsReq {}

message DelMsgsResp {}

message RevokeMsgReq {
  string conversationID = 1;
  int64 seq = 2;
  string userID = 3;
}

message RevokeMsgResp {}

message MarkMsgsAsReadReq {
  string conversationID = 1;
  repeated int64 seqs = 2;
  string userID = 3;
}

message MarkMsgsAsReadResp {}

message MarkConversationAsReadReq {
  string conversationID = 1;
  string userID = 2;
  int64 hasReadSeq = 3;
  repeated int64 seqs = 4;
}

message MarkConversationAsReadResp {}

message SetConversationHasReadSeqReq {
  string conversationID = 1;
  string userID = 2;
  int64 hasReadSeq = 3;
  bool noNotification = 4;
}

message SetConversationHasReadSeqResp {}

message DeleteSyncOpt {
  bool IsSyncSelf = 3;
  bool IsSyncOther = 4;
}

message ClearConversationsMsgReq {
  repeated string conversationIDs = 1;
  string userID = 2;
  DeleteSyncOpt deleteSyncOpt = 3;
}

message ClearConversationsMsgResp {}

message UserClearAllMsgReq {
  string userID = 1;
  DeleteSyncOpt deleteSyncOpt = 3;
}

message UserClearAllMsgResp {}

message DeleteMsgsReq {
  string conversationID = 1;
  repeated int64 seqs = 2;
  string userID = 3;
  DeleteSyncOpt deleteSyncOpt = 4;
}

message DeleteMsgsResp {}

message DeleteMsgPhysicalReq {
  repeated string conversationIDs = 1;
  int64 timestamp = 2;
}

message DeleteMsgPhysicalResp {}

message DeleteMsgPhysicalBySeqReq {
  string conversationID = 1;
  repeated int64 seqs = 2;
}

message DeleteMsgPhysicalBySeqResp {}

message GetMaxSeqsReq {
  repeated string conversationIDs = 1;
}

message GetHasReadSeqsReq {
  string userID = 1;
  repeated string conversationIDs = 2;
}

message SeqsInfoResp {
  map<string, int64> maxSeqs = 1;
}

message GetMsgByConversationIDsReq {
  repeated string conversationIDs = 1;
  map<string, int64> maxSeqs = 2;
}

message GetMsgByConversationIDsResp {
  map<string, sdkws.MsgData> msgDatas = 1;
}

message GetConversationMaxSeqReq {
  string conversationID = 1;
}

message GetConversationMaxSeqResp {
  int64 maxSeq = 1;
}

message GetConversationsHasReadAndMaxSeqReq {
  string userID = 1;
  repeated string conversationIDs = 2;
  bool returnPinned = 3;
}

message Seqs {
  int64 maxSeq = 1;
  int64 hasReadSeq = 2;
  int64 maxSeqTime = 3;
}

message GetConversationsHasReadAndMaxSeqResp {
  map<string, Seqs> seqs = 1;
  repeated string pinnedConversationIDs = 2;
}

message GetActiveUserReq {
  int64 start = 1;
  int64 end = 2;
  bool ase = 3;
  bool group = 4;
  sdkws.RequestPagination pagination = 5;
}

message ActiveUser {
  sdkws.UserInfo user = 1;
  int64 count = 2;
}

message GetActiveUserResp {
  int64 msgCount = 1;
  int64 userCount = 2;
  map<string, int64> dateCount = 3;
  repeated ActiveUser users = 4;
}

message GetActiveGroupReq {
  int64 start = 1;
  int64 end = 2;
  bool ase = 3;
  sdkws.RequestPagination pagination = 4;
}

message ActiveGroup {
  sdkws.GroupInfo group = 1;
  int64 count = 2;
}

message GetActiveGroupResp {
  int64 msgCount = 1;
  int64 groupCount = 2;
  map<string, int64> dateCount = 3;
  repeated ActiveGroup groups = 4;
}

message SearchMessageReq {
  string sendID = 1; //发送者ID
  string recvID = 2; //接收者ID
  int32 contentType = 3;
  string sendTime = 4;
  int32 sessionType = 5;
  sdkws.RequestPagination pagination = 6;
}

message SearchChatLog {
  ChatLog chatLog = 1;
  bool isRevoked = 2;
}

message SearchedMsgData {
  sdkws.MsgData msgData = 1;
  bool isRevoked = 2;
}

message SearchMessageResp {
  repeated SearchChatLog chatLogs = 1;
  int32 chatLogsNum = 2;
}

message ChatLog {
  string serverMsgID = 1;
  string clientMsgID = 2;
  string sendID = 3;
  string recvID = 4;
  string groupID = 5;
  string recvNickname = 6;
  int32 senderPlatformID = 7;
  string senderNickname = 8;
  string senderFaceURL = 9;
  string groupName = 10;
  int32 sessionType = 11;
  int32 msgFrom = 12;
  int32 contentType = 13;
  string content = 14;
  int32 status = 15;
  int64 sendTime = 16;
  int64 createTime = 17;
  string ex = 18;
  string groupFaceURL = 19;
  uint32 groupMemberCount = 20;
  int64 seq = 21;
  string groupOwner = 22;
  int32 groupType = 23;
}

message batchSendMessageReq {
  repeated string recvIDList = 1;
  sdkws.MsgData msgData = 2;
}

message batchSendMessageResp {}
message GetServerTimeReq {}
message GetServerTimeResp {
  int64 serverTime = 1;
}

message ClearMsgReq {
  repeated conversation.Conversation conversations = 1;
}

message ClearMsgResp {}

message DestructMsgsReq {
  int64 timestamp = 1;
  int32 limit = 2;
}

message DestructMsgsResp {
  int32 count = 1;
}

message SetUserConversationsMinSeqReq {
  repeated string userIDs = 1;
  string conversationID = 2;
  int64 seq = 3;
}

message SetUserConversationsMinSeqResp {}

message ConversationSeqs {
  string conversationID = 2;
  repeated int64 seqs = 3;
}

message GetSeqMessageReq {
  string userID = 1;
  repeated ConversationSeqs conversations = 2;
  sdkws.PullOrder order = 3;
}

message GetSeqMessageResp {
  map<string, sdkws.PullMsgs> msgs = 1;
  map<string, sdkws.PullMsgs> notificationMsgs = 2;
}

message GetActiveConversationReq {
  repeated string conversationIDs = 1;
  int64 limit = 2;
}

message ActiveConversation {
  string conversationID = 1;
  int64 lastTime = 2;
  int64 maxSeq = 3;
}

message GetActiveConversationResp {
  repeated ActiveConversation conversations = 1;
}

message SetUserConversationMaxSeqReq {
  string conversationID = 1;
  repeated string ownerUserID = 2;
  int64 maxSeq = 3;
}
message SetUserConversationMaxSeqResp {}

message SetUserConversationMinSeqReq {
  string conversationID = 1;
  repeated string ownerUserID = 2;
  int64 minSeq = 3;
}
message SetUserConversationMinSeqResp {}

message GetLastMessageSeqByTimeReq {
  string conversationID = 1;
  int64 time = 2;
}

message GetLastMessageSeqByTimeResp {
  int64 seq = 1;
}

message GetLastMessageReq {
  string userID = 1;
  repeated string conversationIDs = 2;
}
message GetLastMessageResp {
  map<string,sdkws.MsgData> msgs = 1;
}

// ========== Message Edit Feature ==========

// 消息編輯客戶端信息
message MessageEditClientInfo {
  int32 platform = 1;        // 編輯平台 ID
  string appVersion = 2;     // APP 版本
  string ipAddress = 3;      // IP 地址
}

// 編輯消息請求
message EditMessageReq {
  string conversationID = 1;  // 會話 ID
  int64 seq = 2;              // 消息序列號
  string newContent = 3;      // 新的消息內容
  string editReason = 4;      // 編輯原因（可選）
  MessageEditClientInfo clientInfo = 5;  // 客戶端信息
}

// 編輯消息響應
message EditMessageResp {
  bool success = 1;                    // 是否成功
  string message = 2;                  // 響應消息
  EditedMessageInfo updatedMessage = 3; // 更新後的消息信息
}

// 編輯後的消息信息
message EditedMessageInfo {
  string conversationID = 1;  // 會話 ID
  int64 seq = 2;              // 消息序列號
  string userID = 3;         // 編輯用戶 ID
  bool isEdited = 4;         // 是否已編輯
  int32 editCount = 5;       // 編輯次數
  int64 editTime = 6;        // 編輯時間（毫秒時間戳）
  string lastEditUserID = 7; // 最後編輯者 ID
}

// 消息編輯記錄
message MessageEditRecord {
  string editID = 1;                    // 編輯記錄 ID
  int64 editTime = 2;                   // 編輯時間
  string editUserID = 3;               // 編輯者用戶 ID
  string editUserName = 4;             // 編輯者用戶名
  string oldContent = 5;                // 編輯前內容
  string newContent = 6;                // 編輯後內容
  string editReason = 7;                // 編輯原因
  MessageEditClientInfo clientInfo = 8; // 客戶端信息
}

// 獲取編輯歷史請求
message GetMessageEditHistoryReq {
  string conversationID = 1; // 會話 ID
  int64 seq = 2;              // 消息序列號
}

// 獲取編輯歷史響應
message GetMessageEditHistoryResp {
  bool success = 1;                          // 是否成功
  string message = 2;                        // 響應消息
  repeated MessageEditRecord editHistory = 3; // 編輯歷史記錄
}

// 驗證編輯權限請求
message ValidateEditPermissionReq {
  string conversationID = 1; // 會話 ID
  int64 seq = 2;              // 消息序列號
}

// 驗證編輯權限響應
message ValidateEditPermissionResp {
  bool success = 1;           // 是否成功
  string message = 2;         // 響應消息
  PermissionResult data = 3;  // 權限驗證結果
}

// 權限驗證結果
message PermissionResult {
  bool canEdit = 1;           // 是否可以編輯
  string reason = 2;           // 不能編輯的原因（如果 canEdit 為 false）
  int64 timeRemaining = 3;    // 剩餘編輯時間（秒）
  int32 editCountLeft = 4;   // 剩餘編輯次數
}

// 獲取可編輯消息請求
message GetEditableMessagesReq {
  string conversationID = 1; // 會話 ID
  int32 pageNumber = 2;      // 頁碼
  int32 showNumber = 3;      // 每頁數量
}

// 可編輯消息信息
message EditableMessageInfo {
  int64 seq = 1;                    // 消息序列號
  string content = 2;               // 消息內容
  int32 contentType = 3;           // 內容類型
  int64 sendTime = 4;              // 發送時間
  bool isEdited = 5;               // 是否已編輯
  int32 editCount = 6;             // 編輯次數
  int64 lastEditTime = 7;         // 最後編輯時間
  string lastEditUserID = 8;     // 最後編輯者 ID
  string originalContent = 9;      // 原始內容
}

// 分頁信息
message PaginationInfo {
  int32 pageNumber = 1;  // 當前頁碼
  int32 showNumber = 2;  // 每頁數量
  int64 total = 3;        // 總數量
}

// 獲取可編輯消息響應
message GetEditableMessagesResp {
  bool success = 1;                              // 是否成功
  string message = 2;                            // 響應消息
  string conversationID = 3;                    // 會話 ID
  repeated EditableMessageInfo messages = 4;     // 可編輯消息列表
  PaginationInfo pagination = 5;                 // 分頁信息
}

// 編輯通知數據
message EditNotificationData {
  string notificationType = 1;     // 通知類型（messageEdit）
  string conversationID = 2;       // 會話 ID
  int64 seq = 3;                   // 消息序列號
  int64 editTime = 4;             // 編輯時間
  string editorUserID = 5;       // 編輯者用戶 ID
  string newContent = 6;          // 新內容
  bool isEdited = 7;              // 是否已編輯
  int32 editCount = 8;            // 編輯次數
  string originalSender = 9;      // 原始發送者 ID
  int32 msgType = 10;             // 消息類型
  string clientMsgID = 11;       // 客戶端消息 ID
  string serverMsgID = 12;       // 服務器消息 ID
  int64 createTime = 13;          // 創建時間
  int64 sendTime = 14;            // 發送時間
  int32 sessionType = 15;         // 會話類型
  EditedMessageInfo updatedMessage = 16; // 完整的更新後消息數據
}

// ========== End of Message Edit Feature ==========

service msg {
  //获取最小最大seq（包括用户的，以及指定群组的）
  rpc GetMaxSeq(sdkws.GetMaxSeqReq) returns (sdkws.GetMaxSeqResp);
  //获取会话列表的最大seq
  rpc GetMaxSeqs(GetMaxSeqsReq) returns (SeqsInfoResp);
  //获取会话列表已读的最大seq
  rpc GetHasReadSeqs(GetHasReadSeqsReq) returns (SeqsInfoResp);
  //获取最新消息
  rpc GetMsgByConversationIDs(GetMsgByConversationIDsReq) returns (GetMsgByConversationIDsResp);
  rpc GetConversationMaxSeq(GetConversationMaxSeqReq) returns (GetConversationMaxSeqResp);
  //拉取历史消息（包括用户的，以及指定群组的）
  rpc PullMessageBySeqs(sdkws.PullMessageBySeqsReq) returns (sdkws.PullMessageBySeqsResp);
  rpc GetSeqMessage(GetSeqMessageReq) returns (GetSeqMessageResp);
  rpc SearchMessage(SearchMessageReq) returns (SearchMessageResp);
  //发送消息
  rpc SendMsg(SendMsgReq) returns (SendMsgResp);
  //简易发送消息
  rpc SendSimpleMsg(SendSimpleMsgReq) returns (SendSimpleMsgResp);

  rpc SetUserConversationsMinSeq(SetUserConversationsMinSeqReq) returns (SetUserConversationsMinSeqResp);

  // 全量清空指定会话消息 重置min seq 比最大seq大1
  rpc ClearConversationsMsg(ClearConversationsMsgReq) returns (ClearConversationsMsgResp);
  // 删除用户全部消息 重置min seq 比最大seq大1
  rpc UserClearAllMsg(UserClearAllMsgReq) returns (UserClearAllMsgResp);
  // 用户标记删除部分消息by Seq
  rpc DeleteMsgs(DeleteMsgsReq) returns (DeleteMsgsResp);
  // seq物理删除消息
  rpc DeleteMsgPhysicalBySeq(DeleteMsgPhysicalBySeqReq) returns (DeleteMsgPhysicalBySeqResp);
  // 物理删除消息by 时间
  rpc DeleteMsgPhysical(DeleteMsgPhysicalReq) returns (DeleteMsgPhysicalResp);

  //设置消息是否发送成功-针对api发送的消息
  rpc SetSendMsgStatus(SetSendMsgStatusReq) returns (SetSendMsgStatusResp);
  //获取消息发送状态
  rpc GetSendMsgStatus(GetSendMsgStatusReq) returns (GetSendMsgStatusResp);
  rpc RevokeMsg(RevokeMsgReq) returns (RevokeMsgResp);
  // mark as read
  rpc MarkMsgsAsRead(MarkMsgsAsReadReq) returns (MarkMsgsAsReadResp);
  rpc MarkConversationAsRead(MarkConversationAsReadReq) returns (MarkConversationAsReadResp);
  rpc SetConversationHasReadSeq(SetConversationHasReadSeqReq) returns (SetConversationHasReadSeqResp);

  rpc GetConversationsHasReadAndMaxSeq(GetConversationsHasReadAndMaxSeqReq) returns (GetConversationsHasReadAndMaxSeqResp);
  rpc GetActiveUser(GetActiveUserReq) returns (GetActiveUserResp);
  rpc GetActiveGroup(GetActiveGroupReq) returns (GetActiveGroupResp);
  rpc GetServerTime(GetServerTimeReq) returns (GetServerTimeResp);

  rpc ClearMsg(ClearMsgReq) returns (ClearMsgResp);
  rpc DestructMsgs(DestructMsgsReq) returns (DestructMsgsResp);

  rpc GetActiveConversation(GetActiveConversationReq) returns (GetActiveConversationResp);
  
  rpc SetUserConversationMaxSeq(SetUserConversationMaxSeqReq) returns (SetUserConversationMaxSeqResp);
  rpc SetUserConversationMinSeq(SetUserConversationMinSeqReq) returns (SetUserConversationMinSeqResp);
  rpc GetLastMessageSeqByTime(GetLastMessageSeqByTimeReq) returns (GetLastMessageSeqByTimeResp);
  rpc GetLastMessage(GetLastMessageReq) returns (GetLastMessageResp);

  // Message Edit功能
  rpc EditMessage(EditMessageReq) returns (EditMessageResp);
  rpc GetMessageEditHistory(GetMessageEditHistoryReq) returns (GetMessageEditHistoryResp);
  rpc ValidateEditPermission(ValidateEditPermissionReq) returns (ValidateEditPermissionResp);
  rpc GetEditableMessages(GetEditableMessagesReq) returns (GetEditableMessagesResp);
}
